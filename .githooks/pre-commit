#!/usr/bin/env bash
# Safety: hooks are DISABLED by default. Require ONERING_HOOKS=1 AND ONERING_GATE to run.
# Recursion guard: if ONERING_HOOK_RUNNING already set, skip to prevent loops.
set -euo pipefail

if [ "${ONERING_HOOK_RUNNING:-}" = "1" ]; then
	echo "[pre-commit] Already running (recursion guard); skipping."
	exit 0
fi

if [ "${ONERING_HOOKS:-}" != "1" ]; then
	echo "[pre-commit] Hooks disabled by default. Enable with: ONERING_HOOKS=1 ONERING_GATE=fast|full|docs"
	exit 0
fi

export ONERING_HOOK_RUNNING=1

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

MODE="${ONERING_GATE:-}"

if [[ -z "$MODE" ]]; then
	echo "[pre-commit] ONERING_GATE not set; skipping tests."
	exit 0
fi

case "$MODE" in
	docs)
		echo "[pre-commit] DOCS mode: running docs gate (no tests)."
		pnpm gate -- --mode docs
		;;
	fast)
		echo "[pre-commit] FAST mode: running changed-only gate."
		pnpm gate -- --mode fast
		;;
	full)
		echo "[pre-commit] FULL mode: running full gate."
		pnpm gate -- --mode full
		;;
	*)
		echo "[pre-commit] Unknown ONERING_GATE='$MODE'. Use docs|fast|full."
		exit 1
		;;
esac

exit $?
