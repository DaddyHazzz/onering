// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                    String      @id @default(uuid())
  clerkId               String      @unique
  ringBalance           Int         @default(0)
  verified              Boolean     @default(false)
  postHistory           Post[]
  familyMembers         FamilyMember[]
  marketplaceListings   MarketplaceListing[]
  stakingPositions      StakingPosition[]
  pastThreads           Unsupported("vector(1536)")[]
  profileEmbedding      Unsupported("vector(1536)")?
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  lastLoginAt           DateTime?

  @@map("users")
}

model FamilyMember {
  id                    String      @id @default(uuid())
  userId                String
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  clerkId               String      @unique
  name                  String
  ringBalance           Int         @default(0)
  verified              Boolean     @default(false)
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt

  @@map("family_members")
}

model Post {
  id                    String      @id @default(uuid())
  userId                String
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  platform              String      // 'X', 'Instagram', 'TikTok', etc.
  content               String
  externalId            String?     // Twitter/Instagram post ID
  ringEarned            Int         @default(0)
  status                String      @default("published") // 'scheduled', 'published', 'failed'
  scheduledFor          DateTime?
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt

  @@index([userId])
  @@index([status])
  @@index([scheduledFor])
  @@map("posts")
}

model MarketplaceListing {
  id                    String      @id @default(uuid())
  userId                String
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  title                 String
  description           String
  priceRING             Int         // Price in RING
  status                String      @default("active") // 'active', 'sold', 'cancelled'
  category              String      @default("other") // 'template', 'service', 'tool', 'other'
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt

  @@index([userId])
  @@index([status])
  @@index([category])
  @@map("marketplace_listings")
}

model StakingPosition {
  id                    String      @id @default(uuid())
  userId                String
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount                Int         // RING amount staked
  apr                   Float       @default(5.0) // Annual percentage rate (%)
  durationDays          Int         // Locking period in days
  startDate             DateTime    @default(now())
  claimedYield          Int         @default(0) // Total yield claimed
  status                String      @default("active") // 'active', 'matured', 'withdrawn'
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt

  @@index([userId])
  @@index([status])
  @@map("staking_positions")
}

model RingLedger {
  id            String    @id @default(uuid())
  userId        String    @map("user_id")
  draftId       String?   @map("draft_id")
  requestId     String?   @map("request_id")
  receiptId     String?   @map("receipt_id")
  eventType     String    @map("event_type") // EARN, SPEND, PENALTY, ADJUSTMENT
  reasonCode    String    @map("reason_code")
  amount        Int
  balanceAfter  Int       @map("balance_after")
  metadata      Json      @default("{}")
  createdAt     DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@index([createdAt])
  @@index([eventType])
  @@index([requestId])
  @@map("ring_ledger")
}

model RingPending {
  id            String    @id @default(uuid())
  userId        String    @map("user_id")
  draftId       String?   @map("draft_id")
  requestId     String?   @map("request_id")
  amount        Int
  reasonCode    String    @map("reason_code")
  metadata      Json      @default("{}")
  wouldIssueAt  DateTime  @default(now()) @map("would_issue_at")
  status        String    @default("pending") // pending, issued, expired
  createdAt     DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@index([status])
  @@map("ring_pending")
}

model RingGuardrailsState {
  id              String    @id @default(uuid())
  userId          String    @unique @map("user_id")
  dailyEarnCount  Int       @default(0) @map("daily_earn_count")
  dailyEarnTotal  Int       @default(0) @map("daily_earn_total")
  lastEarnAt      DateTime? @map("last_earn_at")
  anomalyFlags    Json      @default("{}") @map("anomaly_flags")
  resetAt         DateTime  @default(now()) @map("reset_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@index([userId])
  @@map("ring_guardrails_state")
}

model ExternalApiKey {
  id            String    @id @default(uuid())
  keyId         String    @unique @map("key_id")
  keyHash       String    @map("key_hash")
  ownerUserId   String    @map("owner_user_id")
  scopes        String[]  @default([])
  rateLimitTier String    @default("free") @map("rate_limit_tier")
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  lastUsedAt    DateTime? @map("last_used_at")
  expiresAt     DateTime? @map("expires_at")
  metadata      Json      @default("{}")

  @@index([keyId], where: { isActive: true })
  @@index([ownerUserId])
  @@map("external_api_keys")
}

model ExternalWebhook {
  id              String              @id @default(uuid())
  ownerUserId     String              @map("owner_user_id")
  url             String
  secret          String
  events          String[]            @default([])
  isActive        Boolean             @default(true) @map("is_active")
  createdAt       DateTime            @default(now()) @map("created_at")
  lastDeliveredAt DateTime?           @map("last_delivered_at")
  metadata        Json                @default("{}")
  deliveries      WebhookDelivery[]

  @@index([ownerUserId])
  @@index([isActive], where: { isActive: true })
  @@map("external_webhooks")
}

model WebhookDelivery {
  id           String           @id @default(uuid())
  webhookId    String           @map("webhook_id")
  webhook      ExternalWebhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  eventId      String           @map("event_id")
  eventType    String           @map("event_type")
  status       String           // pending, succeeded, failed
  attempts     Int              @default(0)
  lastError    String?          @map("last_error")
  payload      Json
  createdAt    DateTime         @default(now()) @map("created_at")
  deliveredAt  DateTime?        @map("delivered_at")
  nextRetryAt  DateTime?        @map("next_retry_at")

  @@index([webhookId])
  @@index([eventId])
  @@index([status])
  @@index([nextRetryAt], where: { status: "pending" })
  @@map("webhook_deliveries")
}

model ExternalApiRateLimit {
  keyId        String   @map("key_id")
  windowStart  DateTime @map("window_start")
  requestCount Int      @default(0) @map("request_count")

  @@id([keyId, windowStart])
  @@index([windowStart])
  @@map("external_api_rate_limits")
}

model ExternalApiBlocklist {
  id          String    @id @default(uuid())
  targetType  String    @map("target_type")
  targetValue String    @unique @map("target_value")
  reason      String?
  blockedAt   DateTime  @default(now()) @map("blocked_at")
  blockedBy   String?   @map("blocked_by")
  expiresAt   DateTime? @map("expires_at")

  @@index([targetType, targetValue])
  @@map("external_api_blocklist")
}
